#!/bin/bash
# Debug version of vox with detailed error reporting

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}ğŸ” VOX DEBUG MODE${NC}"

# First, let's check if the Python packages are properly installed
echo -e "${BLUE}ğŸ“¦ Checking Python dependencies...${NC}"
python3 -c "
import sys
print(f'Python version: {sys.version}')
try:
    import faster_whisper
    print(f'âœ… faster-whisper version: {faster_whisper.__version__}')
except ImportError as e:
    print(f'âŒ faster-whisper not found: {e}')
    
try:
    import soundfile
    print(f'âœ… soundfile version: {soundfile.__version__}')
except ImportError as e:
    print(f'âŒ soundfile not found: {e}')
    
try:
    import numpy
    print(f'âœ… numpy version: {numpy.__version__}')
except ImportError as e:
    print(f'âŒ numpy not found: {e}')
"

echo ""
echo -e "${BLUE}ğŸ¤ Starting recording test...${NC}"

TEMP_FILE="/tmp/vox_debug_$(date +%s).wav"

# Test recording
echo -e "${YELLOW}Press ENTER when done speaking (recording for max 10 seconds)...${NC}"

if [[ "$OSTYPE" == "darwin"* ]]; then
    if command -v sox &> /dev/null; then
        echo "Using sox for recording..."
        timeout 10 sox -d -r 16000 -c 1 -b 16 "$TEMP_FILE" &
        REC_PID=$!
        read -n 1 -s
        kill $REC_PID 2>/dev/null
        wait $REC_PID 2>/dev/null
    else
        echo "Sox not found, using ffmpeg..."
        timeout 10 ffmpeg -f avfoundation -i ":0" -ar 16000 -ac 1 -acodec pcm_s16le "$TEMP_FILE" -y &
        REC_PID=$!
        read -n 1 -s
        kill $REC_PID 2>/dev/null
        wait $REC_PID 2>/dev/null
    fi
fi

# Check if file was created
if [[ ! -f "$TEMP_FILE" ]]; then
    echo -e "${RED}âŒ Recording file not created${NC}"
    exit 1
fi

# Check file size
FILE_SIZE=$(stat -f%z "$TEMP_FILE" 2>/dev/null || stat -c%s "$TEMP_FILE" 2>/dev/null)
echo -e "${BLUE}ğŸ“„ Recorded file: $TEMP_FILE (${FILE_SIZE} bytes)${NC}"

if [[ $FILE_SIZE -eq 0 ]]; then
    echo -e "${RED}âŒ Recording file is empty${NC}"
    rm -f "$TEMP_FILE"
    exit 1
fi

# Test transcription with detailed error reporting
echo -e "${BLUE}ğŸ§  Testing transcription with detailed logging...${NC}"

python3 << EOF
import sys
import os
import traceback

print("ğŸ” Starting Python transcription debug...")

try:
    print("ğŸ“¦ Importing modules...")
    from faster_whisper import WhisperModel
    import soundfile as sf
    import numpy as np
    print("âœ… All modules imported successfully")
    
    print("ğŸ”§ Initializing Whisper model...")
    model = WhisperModel("tiny", device="cpu", compute_type="int8", cpu_threads=8)
    print("âœ… Model initialized successfully")
    
    print("ğŸ“‚ Loading audio file: $TEMP_FILE")
    if not os.path.exists("$TEMP_FILE"):
        print("âŒ Audio file doesn't exist!")
        sys.exit(1)
        
    file_size = os.path.getsize("$TEMP_FILE")
    print(f"ğŸ“Š File size: {file_size} bytes")
    
    try:
        audio, sr = sf.read("$TEMP_FILE")
        print(f"âœ… Audio loaded: {len(audio)} samples at {sr}Hz")
        print(f"ğŸ“Š Audio duration: {len(audio)/sr:.2f} seconds")
        print(f"ğŸ“Š Audio range: {np.min(audio):.4f} to {np.max(audio):.4f}")
        
        if len(audio) == 0:
            print("âŒ Audio array is empty!")
            sys.exit(1)
            
    except Exception as e:
        print(f"âŒ Failed to load audio: {e}")
        print("ğŸ” Traceback:")
        traceback.print_exc()
        sys.exit(1)
    
    print("ğŸ¯ Starting transcription...")
    try:
        segments, info = model.transcribe(
            audio, 
            beam_size=1,
            language="en",
            condition_on_previous_text=False,
            vad_filter=True,
            vad_parameters=dict(min_silence_duration_ms=300)
        )
        
        print(f"âœ… Transcription completed")
        print(f"ğŸ“Š Language: {info.language}")
        print(f"ğŸ“Š Language probability: {info.language_probability:.2f}")
        
        text_segments = list(segments)
        print(f"ğŸ“Š Number of segments: {len(text_segments)}")
        
        for i, segment in enumerate(text_segments):
            print(f"ğŸµ Segment {i+1}: '{segment.text}' ({segment.start:.2f}s - {segment.end:.2f}s)")
        
        final_text = " ".join([s.text for s in text_segments]).strip()
        
        if not final_text:
            print("âš ï¸  No text was transcribed (empty result)")
        else:
            print(f"âœ… Final transcription: '{final_text}'")
            
    except Exception as e:
        print(f"âŒ Transcription failed: {e}")
        print("ğŸ” Traceback:")
        traceback.print_exc()
        sys.exit(1)
        
except Exception as e:
    print(f"âŒ Critical error: {e}")
    print("ğŸ” Traceback:")
    traceback.print_exc()
    sys.exit(1)

print("âœ… Debug completed successfully!")
EOF

echo ""
echo -e "${BLUE}ğŸ§¹ Cleaning up...${NC}"
rm -f "$TEMP_FILE"
echo -e "${GREEN}Debug session complete!${NC}"